const t = document.getElementById('text');
const c = document.createElement("div");
const b = document.createElement("div");
document.getElementById('game').appendChild(b);
document.getElementById('game').appendChild(c);

let l = 0;
let d = [];
let tm, iv;
let ts = false;
let go = false;

const s = {
    "길거리": {
        "사람에게 다가가기": [
            { n: "김명희 (65)", m: "내가… 어딜 가려 했지? 그런데 뭘 사야했지? " },
            { n: "한서준 (8)", m: "첫 심부름이니까 열심히 하자!" },
            { n: "이수빈 (32)", m: "이번 달은 식비가 빠듯하네… 아껴쓰자." },
            { n: "윤성우 (39)", m: "우리 애들이 심부름을 열심히 하고 있으려나…" },
            { n: "한하윤 (7)", m: "첫 심부름이니까 열심히 하자! 그런데 마트가 어디있지?" },
            { n: "오혜원 (10)", m: "엄마! 엄마… 어디에 있어? " },
            { n: "정하준 (8)", m: "할아버지 우리 어디가?" },
            { n: "정동호 (86)", m: "우리 손자 멋진 머리하러 가는거지! " },
            { n: "박소연 (42)", m: "월급날이니까 맛있는 걸 사야겠어." },
        ],
        "탐색하기": [
            { n: "전봇대", m: "전단지가 붙어 있다." },
            { n: "가로등", m: "불빛이 희미하다." }
        ]
    },
    "부동산": {
        "사람에게 다가가기": [
            { n: "최영일 (54)", m: "우리 애 대학보내려면 아직 빠듯해…" },
            { n: "김영자 (50)", m: "무슨 돈? 생트집 잡지마 학생!" },
            { n: "범유인 (23)", m: "제 돈 돌려낼 생각 없어요?" }
        ],
        "탐색하기": [
            { n: "책상 밑", m: "무언가 작은 장치가 보인다…" }
        ]
    },
    "학원": {
        "사람에게 다가가기": [
            { n: "조은경 (19)", m: "대학가고싶어대학가고싶어..." },
            { n: "정영호 (18)", m: "이게 끝나기는 해?" },
            { n: "최지우 (17)", m: "집에 가고 싶어..." },
            { n: "박서연 (15)", m: "집에 가면 어제 다 못깬 게임 엔딩봐야지." },
            { n: "김지훈 (18)", m: "(멍 때리는 중)" },
            { n: "이지호 (15)", m: "칠판에 적힌 글자를 못알아보겠어…" },
            { n: "강나윤 (17)", m: "올해도 열심히 해야지…" },
            { n: "김명규 (48)", m: "그래도 지금이 좋을 때다~" },
            { n: "이인자 (38)", m: "나도 너희들만 할 때가 있었는데." },
        ],
        "탐색하기": [
            { n: "칠판", m: "‘살고싶어’라는 글자가 희미하게 보인다." }
        ]
    },
    "미용실": {
        "사람에게 다가가기": [
            { n: "한채연 (27)", m: "요즘은 펌 많이 하더라고요. 계절이 바뀌어서 그런가?" },
            { n: "이도겸 (42)", m: "어머~ 컷하러 오셨어요? " },
            { n: "박철수 (89)", m: "내가 오래 다녀봤는데… 머리는 여기가 제일 잘짤라. " },
            { n: "최도윤 (63)", m: "집 가는 길에 애들이 좋아하는 과일 사가야겠다. " },
            { n: "김보영 (22)", m: "일 끝나고 마트에서 맥주 사가야겠다." },
            { n: "한병철 (83)", m: "어? 나는 여기… 머리자르러 왔지. 자네도 자르게?" },
        ],
        "탐색하기": [
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
        ]
    },
    "마트": {
        "사람에게 다가가기": [
            { n: "오예린 (27)", m: "" },
            { n: "이재호 (77)", m: "" },
            { n: "김다혜 (45)", m: "" },
            { n: "정하율 (13)", m: "" },
            { n: "박세빈 (8)", m: "" },
            { n: "김수진 (56)", m: "" },
            { n: "윤태식 (69)", m: "오늘은 어떤 채소가 싱싱하려나?" },
            { n: "이순자 (88)", m: "" },
            { n: "오성민 (47)", m: "" },
            { n: "최말자 (84)", m: "" },
            { n: "유정희 (82)", m: "" },
            { n: "정은지 (40)", m: "" },
            { n: "박지후 (23)", m: "" },
            { n: "윤지우 (16)", m: "" },
            { n: "한지훈 (49)", m: "" },
            { n: "오지은 (38)", m: "" },
            { n: "김지호 (33)", m: "" },
            { n: "박유정 (38)", m: "" },
            { n: "김예림 (17)", m: "공부나 할 걸... 괜히 따라왔어." },
        ],
        "탐색하기": [
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
        ]
    },
    "커피숍": {
        "사람에게 다가가기": [
            { n: "최보영 (50)", m: "" },
            { n: "박도윤 (31)", m: "" },
            { n: "김가온 (12)", m: "" },
            { n: "정하은 (30)", m: "" },
            { n: "이성민 (65)", m: "" },
            { n: "김영자 (90)", m: "" },
            { n: "조영수 (75)", m: "" },
        ],
        "탐색하기": [
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
        ]
    },
    "지하철역": {
        "사람에게 다가가기": [
            { n: "박지헌 (44)", m: "도망쳐! 폭탄이다!!" },
        ],
        "탐색하기": [
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
        ]
    },
    "버스 정류장": {
        "사람에게 다가가기": [
            { n: "최하람 (19)", m: "" },
            { n: "이현아 (55)", m: "" },
            { n: "유진아 (62)", m: "" },
            { n: "정민호 (52)", m: "" },
            { n: "윤세영 (48)", m: "" },
            { n: "한준호 (37)", m: "" },
        ],
        "탐색하기": [
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
        ]
    },
    "제과점": {
        "사람에게 다가가기": [
            { n: "김명자 (78)", m: "" },
            { n: "윤동규 (73)", m: "" },
            { n: "정미라 (64)", m: "" },
            { n: "박선영 (67)", m: "" },
            { n: "한지후 (28)", m: "" },
            { n: "김소민 (16)", m: "" },
            { n: "오하윤 (10)", m: "" },
            { n: "장영호 (79)", m: "" },
        ],
        "탐색하기": [
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
        ]
    },
    "약국": {
        "사람에게 다가가기": [
            { n: "한성민 (73)", m: "" },
            { n: "이주원 (9)", m: "" },
            { n: "장태하 (35)", m: "" },
            { n: "김지헌 (68)", m: "" },
            { n: "이준석 (21)", m: "" },
            { n: "오만수 (81)", m: "" },
            { n: "박수현 (36)", m: "" },
            { n: "오민재 (18)", m: "" },
            { n: "최민서 (29)", m: "" },
        ],
        "탐색하기": [
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
        ]
    },
    "옷가게": {
        "사람에게 다가가기": [
            { n: "정선희 (74)", m: "" },
            { n: "김민재 (43)", m: "" },
            { n: "오현수 (71)", m: "" },
            { n: "이주현 (9)", m: "" },
            { n: "정태우 (13)", m: "" },
            { n: "윤복자 (80)", m: "" },
            { n: "이도훈 (14)", m: "" },
            { n: "김진호 (33)", m: "" },
        ],
        "탐색하기": [
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
        ]
    },
    "패밀리 레스토랑": {
        "사람에게 다가가기": [
            { n: "송정호 (59)", m: "" },
            { n: "이나경 (24)", m: "" },
            { n: "한은별 (7)", m: "" },
            { n: "윤성재 (20)", m: "" },
            { n: "정유진 (20)", m: "" },
            { n: "송미자 (72)", m: "" },
            { n: "김태윤 (25)", m: "" },
            { n: "강보미 (36)", m: "" },
            { n: "최유진 (34)", m: "" },
            { n: "김다은 (25)", m: "" },
            { n: "한도현 (41)", m: "" },
            { n: "박도영 (11)", m: "" },
            { n: "한세은 (10)", m: "" },
            { n: "이승우 (9)", m: "" },
        ],
        "탐색하기": [
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
            { n: "", m: "" },
        ]
    },
};



function tj() {
    if (l >= 5) return "살고싶어...";
    if (l >= 3) return "다시 시작인가요...";
    return "이게 끝나기는 해?";
}

function st() {
    if (ts) return;
    ts = true;
    let time = 60;
    b.style.width = "100%";
    b.style.height = "10px";
    b.style.background = "red";

    iv = setInterval(() => {
        time--;
        b.style.width = `${(time / 60) * 100}%`;
        if (time <= 0) clearInterval(iv);
    }, 1000);

    tm = setTimeout(() => {
        d.push("시간 초과");
        eg();
    }, 60000);
}

function sc(opt) {
    c.innerHTML = "";
    opt.forEach(o => {
        const btn = document.createElement("button");
        btn.innerText = o.t;
        btn.onclick = o.f;
        c.appendChild(btn);
    });
}

function mp(p) {
    const msg = p.n === "정영호 (18)" ? tj() : p.m;
    t.innerText = `${p.n}: "${msg}"`;
    sc([{ t: "뒤로", f: mm }]);
}

function cs(x) {
    st();
    const a = Object.keys(s[x]);
    t.innerText = `${x} 안을 둘러봅니다.`;
    sc(a.map(act => ({
        t: act,
        f: () => {
            const lst = s[x][act];
            sc(lst.map(it => ({
                t: it.n,
                f: () => {
                    if (!it.n.includes("(")) return chk(x, it);
                    d.push(it.n);
                    mp(it);
                }
            })));
        }
    })));
}

function chk(x, it) {
    if (x === "부동산" && it.n === "책상 밑") {
        t.innerText = "책상 밑 장치: 두 줄이 보입니다. 어느 줄을 끊겠습니까?";
        sc([
            { t: "빨간 줄", f: () => eg("r") },
            { t: "파란 줄", f: () => eg("b") },
            { t: "손 떼기", f: mm }
        ]);
    } else {
        t.innerText = it.m;
        sc([{ t: "뒤로", f: mm }]);
    }
}

function sh() {
    t.innerText = "무엇을 소리치겠습니까?";
    sc([
        { t: "‘도와줘!’", f: () => { d.push("주변 사람"); t.innerText = "사람들이 놀라 도망갔습니다."; mm(); } },
        { t: "‘폭탄이야!’", f: () => { d.push("혼란에 빠진 사람들"); t.innerText = "주변이 혼란에 빠졌습니다."; mm(); } },
        { t: "직접 입력", f: si }
    ]);
}

function si() {
    c.innerHTML = "";
    const i = document.createElement("input");
    i.placeholder = "무엇을 외치시겠습니까?";
    const btn = document.createElement("button");
    btn.innerText = "외치기";
    btn.onclick = () => {
        const v = i.value;
        if (v === "폭탄") { d.push("주변 사람"); t.innerText = "사람들이 비명을 지르며 흩어졌습니다."; mm(); }
        else if (v === "도망") { d.push("모든 사람"); t.innerText = "당신은 혼자 도망쳤습니다."; eg(); }
        else { t.innerText = "아무도 반응하지 않았습니다."; mm(); }
    };
    c.appendChild(i);
    c.appendChild(btn);
}

function eg(clr) {
    go = true;
    clearTimeout(tm);
    clearInterval(iv);
    ts = false;
    c.innerHTML = "";

    if (clr === "r") {
        t.innerHTML = "빨간 줄이 끊어졌습니다.<br>전원 사망<br>";
    }
    else if (clr === "b") {
        t.innerHTML = `파란 줄이 끊어졌습니다.<br> 당신만 사망.<br><br>죽은 사람 목록:<br>당신`;
    }
    else {
        t.innerHTML = "폭발 발생<br><br>죽은 사람:<br>" + d.join("<br>");
    }

    sc([
        { t: "회귀하기", f: rg },
        { t: "포기하기", f: gu }
    ]);
}

function gu() {
    t.innerHTML = "당신은 긴 싸움에서 패배하였습니다. <br> <br>you lose...";
    c.innerHTML = "";
    setTimeout(() => { window.location.href = "index.html"; }, 3000);
}

function mm() {
    st();
    t.innerText = `you're winning! \n회귀 횟수: ${l}\n무엇을 하시겠습니까? `
    sc([
        { t: "소리치기", f: sh },
        { t: "탐색하기", f: () => sc(Object.keys(s).map(x => ({ t: x, f: () => cs(x) }))) },
        { t: "도망가기", f: () => { t.innerText = "도망쳤지만 아무도 살지 못했습니다."; eg(); } }
    ]);
}

function rg() {
    l++;
    d = [];
    go = false;
    ts = false;
    t.innerText = "다시 눈을 떴습니다.";
    mm();
}

mm();
